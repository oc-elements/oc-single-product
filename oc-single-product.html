<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../oc-product-api/oc-product-api.html">
<link rel="import" href="../oc-toast/oc-toast.html">


<dom-module id="oc-single-product">
  <template>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>

      :host {
        display: block;
        font-family: var(--paper-font-common-base_-_font-family);

      }

      .category-heading {
        border-top: 1px #cecece solid;
        border-bottom: 1px #cecece solid;
        background: #f8f8f8;
        color: #000;
        margin-top:-1px;
      }
      .clear-heading {
        background: #fff;
        padding: 12px 0;
        margin-top:-1px;
      }

      h3 {
        font-size:1.13em !important;
        margin: 10px 0 !important;
      }

      .add-button-row {
        background: #ffffff;
        margin: 15px 0;
      }
      .add-button {
        width: 100%;
        color: #fff;
        background: #2BB673;
      }

      .close-button {
        width: 100%;
        color: #fff;
        background: lightgray;
      }

      .small-price {
        font-size:1.375em;
        position:absolute;
      }
      .large-price {
        font-size:2.45em;
        position:absolute;
        left:26px;
      }

      paper-button {
        min-width:3em;
      }
      paper-button.bordered {
        border: 1px solid #000;
      }

      .quantity-box {
        -webkit-border-radius: 6px;
        -moz-border-radius: 6px;
        border-radius: 6px;
        padding: 2px 20px;
        background: #ccc;
        margin-right: 4px;
        background: #cecece;
      }

      .quantity-box h4 {
        font-weight:bold;
      }
      .images img{
        width: 100%;
      }


    </style>
    <oc-toast id="toast"></oc-toast>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12">
          <div class="images">
            <img src="[[product.images.0.name]]" alt="product image">
          </div>
        </div>
      </div>
      <div class="row category-heading">
        <div class="col-xs-8 heading-section">

          <h3>[[product.name]]</h3>
          <span><small>[[product.shortDescription]]
          </small></span>
          <span>[[product.id]]</span>
        </div>
        <div class="col-xs-4">
          <span><small><del>R[[product.price]]</del></small></span>
          <div><span class="small-price">R</span><span class="large-price" id="product-price">[[product.price]]</span></div>
        </div>
      </div>
      <div class="row category-heading">
        <div class="col-xs-12">
          <h3>Product Description</h3>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12">
          <p>[[product.description]]</p>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12">

          <div class="row category-heading clear-heading">
            <div class="col-xs-4">
              Quantity
            </div>
            <div class="col-xs-8">

              <div class="pull-right">
                <paper-button class="bordered pull-right" on-tap="_increaseValue">+</paper-button>
                <paper-input id="quantity-input" value="{{product.initQuantity}}"></paper-input>
                <paper-button class="bordered pull-right" on-tap="_decreaseValue">-</paper-button>
              </div>
              <div class="quantity-box pull-right"><h4>{{product.initQuantity}}</h4></div>
            </div>
          </div>
          <div class="row category-heading clear-heading">
            <div class="col-xs-6">
              Total:
            </div>
            <div class="col-xs-6">
              <span class="pull-right">R </span><span id="total-cost">{{total-cost}}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12 add-button-row">
          <paper-button class="add-button" on-tap="_addToCart">Add to Cart</paper-button>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12 close-button-row">
          <paper-button class="close-button" on-tap="_closeSingleProduct">Back</paper-button>
        </div>
      </div>
    </div>
  </template>

  <script>
      /**
       * `oc-single-product`
       * Show a single product of an organisation.
       *
       * @customElement
       * @polymer
       * @demo demo/index.html
       */
      class OcSingleProduct extends olymer.Element {
          static get is() { return 'oc-single-product'; }
          static get properties() { return {
              product: {
                  type: Number,
                  value: {}
              },

              cartData: {
                  type: Object,
                  value: {}
              },
              _cartDataQuantity: {
                  type: Number,
                  value: 1,
                  notify: true
              }

          };
          }

          ready() {
              super.ready();
              this._init();
              this.addEventListener('increase-value', (e)=>this._increaseValue(e));
              this.addEventListener('decrease-value', (e)=>this._decreaseValue(e));
          }



          /**
           * Close the product to show the list of products. Listens in shop-product-list
           */
          _closeSingleProduct () {
              this.dispatchEvent(new CustomEvent('close-single-product', {
                  bubbles: true, composed: true
              }));
          }

          // Check if next item's seller matches with the sellers in current cart
          _isValidToAddNewItems() {
              if(this.cartData.items) {
                  for (let i = 0; i < this.cartData.items.length; i++) {
                      if (this.cartData.items[i].detail.organisation.id === this.product.organisation.id) continue;

                      this.$.toast.failed("You may only have one seller's items in basket \n" +
                          "First checkout or remove the other seller's items from cart.");
                      return false
                  }
              }
              return true
          }

          /**
           * Add item to cart
           */
          _addToCart(event) {
              // Don't add item to cart if false
              if (!this._isValidToAddNewItems()) return;

              let data = {};
              data.quantity = this.product.initQuantity;
              data.productId = this.product.id;
              // need to add check for empty call.
              this.dispatchEvent(new CustomEvent('add-to-cart', {
                  bubbles: true, composed: true, detail:
                      {cartData: data}
              }));
          }

          _increaseValue() {
              var value = parseInt(this.shadowRoot.getElementById('quantity-input').value, 10);
              value = isNaN(value) ? 1 : value;
              value++;
              this.shadowRoot.getElementById('quantity-input').value = value;
          }

          _decreaseValue() {
              var value = parseInt(this.shadowRoot.getElementById('quantity-input').value, 10);
              value = isNaN(value) ? 2 : value;
              value < 2 ? value = 2 : '';
              value--;
              this.shadowRoot.getElementById('quantity-input').value = value;
          }
      }

      window.customElements.define(OcSingleProduct.is, OcSingleProduct);
  </script>
</dom-module>