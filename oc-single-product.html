<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../oc-product-api/oc-product-api.html">
<link rel="import" href="../oc-toast/oc-toast.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-input/iron-input.html">
<dom-module id="oc-single-product">
  <template>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>

      :host {
        display: block;
		background: #f8f8f8;
        font-family: var(--paper-font-common-base_-_font-family);
		--paper-input-container-input-color: black;
		/* --iron-input: {
			border: 1px solid;
			padding: 2px;
			border-radius: 5px;
		} */
        --paper-input-container:{
          /* border: 1px solid #000; */
		  position: absolute;
		  top:-20px;
		  right:20px;
          /* padding: 0 !important; */
          width:50px !important;
		  /* height: 30px; */
		  /* border-radius:5px; */
		  /* font-size:6px; */
        };
        /* --paper-input-container-input: {
          margin-left: 10px;
        };
        --paper-input-container-label: {
          margin-left: 10px;
        }; */
		--paper-input: {
			width:20px;
		};
		paper-input: {
			width:20px;
		}
      }

      .category-heading {
        border-top: 1px #cecece solid;
        border-bottom: 1px #cecece solid;
        background: #f8f8f8;
        color: #000;
		margin: -1px -15px 0 -15px;
      }
      .clear-heading {
        background: #fff;
        padding: 12px 0;
        margin-top:-1px;
      }
	  .product-description p {
		  color:#33404d;
		  padding:10px 0 20px 0;
	  }
      h3 {
        font-size:1.23em !important;
		font-weight:800 !important;
        margin: 10px 0 !important;
      }

      .add-button-row {
        background: #ffffff;
        margin: 15px 0;
      }
      .add-button {
        width: 100%;
        color: #fff;
        background: #2BB673;
      }

      .close-button {
        width: 100%;
        color: #fff;
        background: lightgray;
      }

      .large-price {
		color: #2BB673;
        font-size:1.45em;
		font-weight: 800 !important;
        position:absolute;
      }

	  .inline-input {
		  color: red;
	  }

      paper-button.bordered {
        border: 1px solid #000;
      }

      .images img{
        display: block;
        margin:auto;
        max-height:120px;
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

	</style>
	<oc-toast id="toast"></oc-toast>
    <div class="container-fluid">
      <div class="row category-heading">
        <div class="col-xs-5">
          <div class="images center">
            <img src="[[product.images.0.name]]" alt="product image" class="pull-left">
          </div>
		</div>
		<div class="col-xs-7 heading-section">
				<h3>[[product.name]]</h3>
					<span>[[product.shortDescription]]</span>
				<template is="dom-if" if="[[item.discount">
						<span>R[[product.discount.originalPrice]]</del></small></span>
					  </template>
				<div><span class="large-price" id="product-price">R [[product.price]]</span></div>

		</div>
      </div>
      <div class="row category-heading">

        <div class="col-xs-4">

        </div>
	  </div>
	  <template is="dom-if" if="[[!product.optionSets.0]]">
		<div class="row category-heading">
			<div class="col-xs-6">
				<div>[[product.name]]</div>
				<div>@ R[[product.price]]</div>
			</div>
			<div class="col-xs-6">
				<div class="horizontal">
					<span style="margin-top:10px">Qty</span>
					<iron-input bind-value="{{_quantity}}"><input class="pull-right" id="" bind-value="{{_quantity::input}}" type="number" placeholder="1" allowed-pattern="[0-9]"style="width: 60px;
						margin-left: 10px;
						margin-top: 10px;
						padding: 0px 5px;
						border: 1px solid #000;
						border-radius: 5px;">
						</input>
					</iron-input>
					<span style="margin: 10px 0 0 10px;
					background: orange;
					color: #fff;
					font-size: 11px;
					border-radius: 5px;
					padding: 6px 8px;
					height: 26px;" on-tap="_addToCart">ADD</span>
				</div>
			</div>
		</div>
		<div class="row">
		  <div class="col-xs-12 product-description">
			<p><pre style="white-space:pre-wrap">[[product.description]]</pre></p>
		  </div>
		</div>
	  </template>
	  <template is="dom-if" if="[[product.optionSets.0]]">
		  <template is="dom-repeat" items="[[product.optionSets.0.options]]" as="item" selected="[[selectedOption._selectedQuantity]]">
		<div class="row category-heading">
			<div class="col-xs-6">
				<div>[[item.name]]</div>
				<div>@ R[[item.price]]</div>
			</div>
			<div class="col-xs-6">
				<div class="horizontal">
					<span style="margin-top:10px">Qty</span>
					<iron-input bind-value="{{item._selectedQuantity}}"><input class="pull-right" id="" bind-value="{{_selectedQuantity::input}}" type="number" placeholder="0" allowed-pattern="[0-9]"style="width: 60px;
						margin-left: 10px;
						margin-top: 10px;
						padding: 0px 5px;
						border: 1px solid #000;
						border-radius: 5px;">
					</input>
					</iron-input>
					<span style="margin: 10px 0 0 10px;
						background: orange;
						color: #fff;
						font-size: 11px;
						border-radius: 5px;
						padding: 6px 8px;
						height: 26px;" on-tap="_addOptionToCart">ADD</span>
				</div>
			</div>
		</div>
	</template>
	<div class="row">
		<div class="col-xs-12 product-description">
			<p><pre style="white-space:pre-wrap">[[product.description]]</pre></p>
		</div>
	</div>
	</template>
    </div>
  </template>

  <script>
      class OcSingleProduct extends Polymer.Element {
          static get is() { return 'oc-single-product'; }
          static get properties() { return {
              product: {
                  type: Number,
                  value: {}
			  },
			  _product: {
					type: Object,
					value: {}
					},

              cartData: {
                  type: Object,
                  value: {}
			  },
			  	productObject: {
					type:Object
				},
				_quantity: {
					type: Number,
					notify: true,
					value: 1
				},
				_selectedQuantity: {
					type: Number,
					notify: true,
					value: 1
				},
        _cartDataQuantity: {
            type: Number,
            value: 1,
            notify: true
        }

		  };

		  }
          ready() {
              super.ready();
		  }
		  setQuantity(_selectedQuantity) {
				this._selectedQuantity = 1;
		  }
          /**
           * Close the product to show the list of products. Listens in shop-product-list
           */
          _closeSingleProduct () {
              this.dispatchEvent(new CustomEvent('close-single-product', {
                  bubbles: true, composed: true
              }));
          }

          // Check if next item's seller matches with the sellers in current cart
          _isValidToAddNewItems() {
              if(this.cartData.items) {
                  for (let i = 0; i < this.cartData.items.length; i++) {
                      if (this.cartData.items[i].detail.organisation.id === this.product.organisation.id) continue;

                      this.$.toast.failed("You may only have one seller's items in basket \n" +
                          "First checkout or remove the other seller's items from cart.");
                      return false
                  }
              }
              return true
          }

          /**
           * Add item or option to cart
           */

          _addToCart(event) {
              // Don't add item to cart if false
              if (!this._isValidToAddNewItems()) return;
			  this.productObject = {
						item: this.product,
						quantity: this._quantity
					}
              this.dispatchEvent(new CustomEvent('add-to-cart', {
				bubbles: true, composed: true, detail: this.productObject
			  }));
			  this._quantity = 1;
		  }
		  _addOptionToCart(e){
              // Don't add item to cart if false
			if (!this._isValidToAddNewItems()) return;
			if (e.model.item._selectedQuantity > 0) {
			this.mainProduct = {
					item: this.product,
					quantity: e.model.item._selectedQuantity
				};
				this.productOption = {
					item:  {

					},
				};

			  let productMerged = Object.assign({}, this.mainProduct.item, this.productOption.item );
			  this.productObject = {

						item: productMerged,
						quantity: e.model.item._selectedQuantity,
						options: e.model.item
					}
              this.dispatchEvent(new CustomEvent('add-to-cart', {
				bubbles: true, composed: true, detail: this.productObject
			  }));
			}
			else {
				this.$.toast.failed("Quantity of 1 or more required.");
			}
		  }
      }

      window.customElements.define(OcSingleProduct.is, OcSingleProduct);
  </script>
</dom-module>
